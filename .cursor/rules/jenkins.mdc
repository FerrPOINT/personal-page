---
description: "–ü—Ä–∞–≤–∏–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Jenkins CI/CD Pipeline –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è"
globs: ["Jenkinsfile", "scripts/deploy.sh", "**/jenkins*.qmd", "**/jenkins*.md"]
alwaysApply: false
---

# Jenkins CI/CD Pipeline Setup Rules

## üéØ –û–±–∑–æ—Ä Jenkins CI/CD Pipeline

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Jenkins –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ main –≤–µ—Ç–∫—É.
Pipeline –≤—ã–ø–æ–ª–Ω—è–µ—Ç: checkout ‚Üí validate ‚Üí deploy –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SSH.

### üìã –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞

**Jenkins Server:**
- URL: `http://192.168.1.49:32768/`
- API Token: `1191a9f019fc3989d7a5ff30d456fb9cf3`
- Job Name: `personal-page-deploy`

**Deployment Server:**
- SSH –∫–æ–º–∞–Ω–¥–∞: `ssh -i ~/.ssh/id_rsa root@azhukov-dev`
- Host: `azhukov-dev` (–∏–ª–∏ `7eb10d5af2ad.vps.myjino.ru:49233`)
- User: `root`
- Path: `/opt/personal-page`

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
GitHub Push ‚Üí Jenkins Webhook ‚Üí Jenkins Pipeline ‚Üí SSH to Server ‚Üí deploy.sh ‚Üí Docker Compose
```

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `Jenkinsfile` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pipeline –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
- `scripts/deploy.sh` - —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- SSH credentials –≤ Jenkins (ID: `jenkins-ssh-deploy-key`)
- Docker Compose –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Jenkins –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ Jenkinsfile

–°–æ–∑–¥–∞–π `Jenkinsfile` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

```groovy
pipeline {
    agent any
    
    environment {
        DEPLOY_HOST = 'your-server.example.com'
        DEPLOY_PORT = '22'
        DEPLOY_USER = 'root'
        DEPLOY_PATH = '/opt/your-project'
        COMPOSE_PROJECT_NAME = 'your-project'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "üîÑ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
                    checkout scm
                }
            }
        }
        
        stage('Validate') {
            steps {
                script {
                    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞..."
                    sh 'test -f Jenkinsfile && echo "‚úÖ Jenkinsfile –Ω–∞–π–¥–µ–Ω" || exit 1'
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä ${DEPLOY_HOST}:${DEPLOY_PORT}..."
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'jenkins-ssh-deploy-key',
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {
                        sh """
                            SSH_PORT_FLAG=""
                            if [ "${DEPLOY_PORT}" != "22" ]; then
                                SSH_PORT_FLAG="-p ${DEPLOY_PORT}"
                            fi
                            
                            ssh -o StrictHostKeyChecking=no -i \${SSH_KEY} \${SSH_PORT_FLAG} ${DEPLOY_USER}@${DEPLOY_HOST} \\
                                "cd ${DEPLOY_PATH} && \\
                                 git fetch origin && \\
                                 git checkout -f origin/main || git checkout -f origin/master && \\
                                 chmod +x scripts/deploy.sh && \\
                                 bash scripts/deploy.sh"
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "‚úÖ Pipeline –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        }
        failure {
            echo "‚ùå Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
        }
    }
}
```

**–í–∞–∂–Ω–æ:** –ò–∑–º–µ–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `DEPLOY_HOST`, `DEPLOY_PORT`, `DEPLOY_USER`, `DEPLOY_PATH`, `COMPOSE_PROJECT_NAME` –ø–æ–¥ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç.

### 2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–µ–ø–ª–æ—è

–°–æ–∑–¥–∞–π `scripts/deploy.sh` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```bash
#!/bin/bash
set -e

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
if [ -f env.prod ]; then
    cp env.prod .env
    echo "‚úÖ env.prod —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ .env"
fi

echo "üê≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose down || true

echo "üî® –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose up -d --build

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 5

echo "üóÑÔ∏è  –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
docker compose exec -T backend npm run migrate || echo "‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞"

echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose ps

echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 3

if curl -f http://localhost:9000/health > /dev/null 2>&1; then
    echo "‚úÖ Backend health check: OK"
else
    echo "‚ùå Backend health check: FAILED"
    docker compose logs --tail=50 backend
    exit 1
fi

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
```

**–í–∞–∂–Ω–æ:** –ê–¥–∞–ø—Ç–∏—Ä—É–π health check endpoint –∏ –∫–æ–º–∞–Ω–¥—ã –º–∏–≥—Ä–∞—Ü–∏–π –ø–æ–¥ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç.

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Jenkins

**–®–∞–≥–∏:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏ –ø–ª–∞–≥–∏–Ω—ã: Pipeline, Git, SSH Agent, Credentials Binding
2. –°–æ–∑–¥–∞–π SSH credentials:
   - ID: `jenkins-ssh-deploy-key` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
   - Kind: SSH Username with private key
   - Username: `root` (–∏–ª–∏ –≤–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
   - Private Key: –≤—Å—Ç–∞–≤—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á
3. –°–æ–∑–¥–∞–π Pipeline Job:
   - Name: `<project-name>-deploy`
   - Definition: Pipeline script from SCM
   - SCM: Git
   - Repository URL: URL –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
   - Script Path: `Jenkinsfile`

### 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–µ–ø–ª–æ—è

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–µ–ø–ª–æ—è:
mkdir -p /opt/your-project
cd /opt/your-project
git clone <repo-url> .
cp env.example.txt env.prod
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π env.prod —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
chmod +x scripts/deploy.sh
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
- Docker –∏ Docker Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- SSH –¥–æ—Å—Ç—É–ø —Å root –ø—Ä–∞–≤–∞–º–∏
- –ü—É–±–ª–∏—á–Ω—ã–π SSH –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ `~/.ssh/authorized_keys`

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π

Pipeline –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ push –≤ `main` –≤–µ—Ç–∫—É (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω webhook).

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

```bash
# –ß–µ—Ä–µ–∑ Jenkins UI
# –û—Ç–∫—Ä–æ–π Job ‚Üí Build Now

# –ß–µ—Ä–µ–∑ API
curl -X POST \
  "http://<JENKINS_HOST>:<PORT>/job/<job-name>/build" \
  --user "<user>:<token>"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ build
curl -s -u <user>:<token> \
  "http://<JENKINS_HOST>:<PORT>/job/<job-name>/lastBuild/api/json?tree=result"

# –õ–æ–≥–∏
curl -s -u <user>:<token> \
  "http://<JENKINS_HOST>:<PORT>/job/<job-name>/lastBuild/consoleText" | tail -50
```

## üêõ Troubleshooting

### "Could not find credentials entry"
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ credentials —Å–æ–∑–¥–∞–Ω—ã —Å ID `jenkins-ssh-deploy-key`
- –ü—Ä–æ–≤–µ—Ä—å Scope credentials (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Global)

### "Permission denied (publickey)"
- –î–æ–±–∞–≤—å –ø—É–±–ª–∏—á–Ω—ã–π SSH –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä: `ssh-copy-id -i ~/.ssh/id_ed25519.pub -p <PORT> root@<HOST>`
- –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ –Ω–∞ –∫–ª—é—á: `chmod 600 ~/.ssh/id_ed25519`

### "docker-compose: not found"
- –ò—Å–ø–æ–ª—å–∑—É–π `docker compose` (–±–µ–∑ –¥–µ—Ñ–∏—Å–∞) –≤ —Å–∫—Ä–∏–ø—Ç–µ
- –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏ Docker Compose –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### Build –∑–∞–≤–∏—Å–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å —Ç–∞–π–º–∞—É—Ç –≤ Jenkinsfile (—É–≤–µ–ª–∏—á—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
- –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –¥–µ–ø–ª–æ—è
- –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: `docker compose logs`

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ü–æ–ª–Ω—ã–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞:**
- `info/jenkins-cicd-setup-guide.qmd` - –ø–æ–ª–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- `info/jenkins-quick-reference.qmd` - –±—ã—Å—Ç—Ä–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞
- `info/jenkins-pipeline.qmd` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ pipeline

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

- [ ] Jenkinsfile —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] scripts/deploy.sh —Å–æ–∑–¥–∞–Ω –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- [ ] SSH credentials —Å–æ–∑–¥–∞–Ω—ã –≤ Jenkins (ID: `jenkins-ssh-deploy-key`)
- [ ] Pipeline Job —Å–æ–∑–¥–∞–Ω –≤ Jenkins
- [ ] –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–µ–ø–ª–æ—è
- [ ] env.prod –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] Docker –∏ Docker Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ü–µ—Ä–≤—ã–π build –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] GitHub Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–π –æ—Ç–¥–µ–ª—å–Ω—ã–π SSH –∫–ª—é—á –¥–ª—è Jenkins
- –ù–µ —Ö—Ä–∞–Ω–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- –•—Ä–∞–Ω–∏ —Å–µ–∫—Ä–µ—Ç—ã –≤ `env.prod` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–µ –∫–æ–º–º–∏—Ç—å `.env`)
- –û–≥—Ä–∞–Ω–∏—á—å –¥–æ—Å—Ç—É–ø –∫ Jenkins UI
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π SSH –∫–ª—é—á–∏

## üí° –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Credentials ID –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω:** `jenkins-ssh-deploy-key` –¥–æ–ª–∂–µ–Ω —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å –≤ Jenkinsfile –∏ Jenkins UI
2. **–ü—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É:** `scripts/deploy.sh` –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
3. **–ü—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:** `chmod +x scripts/deploy.sh` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
4. **–í–µ—Ç–∫–∞:** Pipeline –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `origin/main` –∏–ª–∏ `origin/master` (–∞–¥–∞–ø—Ç–∏—Ä—É–π –ø–æ–¥ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç)
5. **Health check:** –ê–¥–∞–ø—Ç–∏—Ä—É–π endpoint –∏ –ø–æ—Ä—Ç –ø–æ–¥ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç

## üéØ –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

1. –°–∫–æ–ø–∏—Ä—É–π `Jenkinsfile` –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –°–æ–∑–¥–∞–π `scripts/deploy.sh` –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–∞
3. –ù–∞—Å—Ç—Ä–æ–π Jenkins credentials –∏ Job
4. –ü–æ–¥–≥–æ—Ç–æ–≤—å —Å–µ—Ä–≤–µ—Ä –¥–µ–ø–ª–æ—è
5. –ó–∞–ø—É—Å—Ç–∏ –ø–µ—Ä–≤—ã–π build –∏ –ø—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
