# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Jenkins Pipeline

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. **Jenkinsfile —Å–æ–∑–¥–∞–Ω** - pipeline –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è
2. **Jenkins job —Å–æ–∑–¥–∞–Ω** - `personal-page-deploy` —á–µ—Ä–µ–∑ REST API
3. **–°–∫—Ä–∏–ø—Ç—ã —Å–æ–∑–¥–∞–Ω—ã** - –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

---

## üöÄ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω—ã –≤ Jenkins

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Jenkins UI: `http://192.168.1.49:32768/`

**Manage Jenkins** ‚Üí **Plugins** ‚Üí **Available plugins**

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
- ‚úÖ **Pipeline** (workflow-aggregator)
- ‚úÖ **SSH Pipeline Steps** (ssh-steps)
- ‚úÖ **Docker Pipeline** (docker-workflow)
- ‚úÖ **Git Plugin** (git)
- ‚úÖ **SSH Credentials Plugin** (ssh-credentials)

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSH Credentials

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É:

```bash
# –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É SSH –∫–ª—é—á—É
bash scripts/setup-jenkins-ssh-credentials.sh ~/.ssh/id_rsa

# –ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è Jenkins
ssh-keygen -t ed25519 -C "jenkins-deploy" -f ~/.ssh/jenkins_deploy_key
bash scripts/setup-jenkins-ssh-credentials.sh ~/.ssh/jenkins_deploy_key
```

**–í–∞–∂–Ω–æ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–µ–ø–ª–æ—è:
```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
cat ~/.ssh/jenkins_deploy_key.pub

# –î–æ–±–∞–≤—å—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@7eb10d5af2ad.vps.myjino.ru -p 49233
mkdir -p ~/.ssh
echo "–í–ê–®_–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ Jenkins UI (–≤—Ä—É—á–Ω—É—é)

1. **Manage Jenkins** ‚Üí **Credentials** ‚Üí **System** ‚Üí **Global credentials**
2. **Add Credentials**
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - **Kind**: SSH Username with private key
   - **ID**: `jenkins-ssh-deploy-key`
   - **Username**: `root`
   - **Private Key**: –í—ã–±–µ—Ä–∏—Ç–µ **Enter directly** –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Git Credentials (–µ—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π)

–ï—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Git credentials:

1. **Manage Jenkins** ‚Üí **Credentials** ‚Üí **System** ‚Üí **Global credentials**
2. **Add Credentials**
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - **Kind**: SSH Username with private key (–¥–ª—è SSH) –∏–ª–∏ Username with password (–¥–ª—è HTTPS)
   - **ID**: `jenkins-git-credentials`
   - –£–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ GitHub

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–µ—Ä–≤—ã–π build

#### –ß–µ—Ä–µ–∑ Jenkins UI:
1. –û—Ç–∫—Ä–æ–π—Ç–µ: `http://192.168.1.49:32768/job/personal-page-deploy`
2. –ù–∞–∂–º–∏—Ç–µ **Build Now**

#### –ß–µ—Ä–µ–∑ API:
```bash
curl -X POST -u ferrpoint:YOUR_JENKINS_API_TOKEN \
  http://192.168.1.49:32768/job/personal-page-deploy/build
```

#### –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç:
```bash
bash scripts/trigger-jenkins-build.sh
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å job:
```bash
curl -s -u ferrpoint:YOUR_JENKINS_API_TOKEN \
  "http://192.168.1.49:32768/job/personal-page-deploy/api/json?tree=lastBuild[number,result,url]"
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ build:
```bash
curl -s -u ferrpoint:YOUR_JENKINS_API_TOKEN \
  "http://192.168.1.49:32768/job/personal-page-deploy/lastBuild/consoleText"
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ GitHub: **Settings** ‚Üí **Webhooks** ‚Üí **Add webhook**
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - **Payload URL**: `http://192.168.1.49:32768/github-webhook/`
   - **Content type**: `application/json`
   - **Events**: Just the push event
3. –ù–∞–∂–º–∏—Ç–µ **Add webhook**

**–í–∞–∂–Ω–æ**: Jenkins –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è webhook. –ï—Å–ª–∏ Jenkins –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Poll SCM –≤–º–µ—Å—Ç–æ webhook.

---

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Pipeline

```{mermaid}
graph TD
    A[Git Push] --> B[Checkout]
    B --> C[Build Docker Images]
    C --> D[Deploy to Server]
    D --> E[Run Migrations]
    E --> F[Health Check]
    F --> G{Success?}
    G -->|Yes| H[‚úÖ Done]
    G -->|No| I[‚ùå Failed]
    
    style A fill:#e1f5ff
    style H fill:#d4edda
    style I fill:#f8d7da
```

1. **Checkout** - –∫–ª–æ–Ω–∏—Ä—É–µ—Ç –∫–æ–¥ –∏–∑ `git@github.com:FerrPOINT/personal-page.git`
2. **Build** - —Å–æ–±–∏—Ä–∞–µ—Ç Docker –æ–±—Ä–∞–∑—ã –¥–ª—è frontend –∏ backend
3. **Deploy** - –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
   - `git pull` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
   - `docker compose up -d --build`
   - –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
4. **Health Check** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `/health` endpoint

---

## üêõ Troubleshooting

### Job –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ**:
1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–ª–∞–≥–∏–Ω—ã
2. –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ª–∏ SSH credentials (`jenkins-ssh-deploy-key`)
3. –î–æ—Å—Ç—É–ø–µ–Ω –ª–∏ Jenkins agent —Å Docker

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å job
bash scripts/check-jenkins.sh

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
curl -s -u ferrpoint:YOUR_JENKINS_API_TOKEN \
  "http://192.168.1.49:32768/job/personal-page-deploy/lastBuild/consoleText" | tail -50
```

### SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ**:
1. SSH –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ Jenkins credentials
2. –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
3. –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω: `ssh -p 49233 root@7eb10d5af2ad.vps.myjino.ru`

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –¥–æ—Å—Ç—É–ø –≤—Ä—É—á–Ω—É—é
ssh -p 49233 root@7eb10d5af2ad.vps.myjino.ru

# –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–±–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä
cat ~/.ssh/id_rsa.pub | ssh -p 49233 root@7eb10d5af2ad.vps.myjino.ru "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

### Docker –æ–±—Ä–∞–∑—ã –Ω–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ**:
1. Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ Jenkins agent
2. –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Docker: `docker ps`

**–†–µ—à–µ–Ω–∏–µ**:
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Jenkins agent –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ Docker
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –≤ Jenkins Console Output

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `info/jenkins-pipeline.qmd`
- **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç**: `info/jenkins-quickstart.qmd`
- **Jenkins API**: http://192.168.1.49:32768/api/

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç

- [x] Jenkinsfile —Å–æ–∑–¥–∞–Ω
- [x] Jenkins job —Å–æ–∑–¥–∞–Ω (`personal-page-deploy`)
- [ ] –ü–ª–∞–≥–∏–Ω—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ Jenkins
- [ ] SSH credentials –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (`jenkins-ssh-deploy-key`)
- [ ] Git credentials –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–µ—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
- [ ] –ü–µ—Ä–≤—ã–π build –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

**–ì–æ—Ç–æ–≤–æ!** Pipeline –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

